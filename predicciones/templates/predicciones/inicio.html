{% extends 'base.html' %}

{% block title %}Predicciones{% endblock %}
{% block page_title %}{{ page_title|default:'Predicciones' }}{% endblock %}
{% block page_subtitle %}{{ page_subtitle|default:'Selecciona un cliente para analizar riesgo' }}{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <p class="text-muted">Página de predicciones (MVP). Selecciona un cliente para generar una predicción.</p>

    {% if can_train %}
      <div class="d-flex align-items-center gap-2 mb-3">
        <button type="button" class="btn btn-outline-primary" id="btnEntrenarModelo" data-url="{% url 'predicciones:entrenar_modelo' %}">
          Entrenar modelo
        </button>
        <small class="text-muted">(Requiere que existan clientes inactivos para poder entrenar)</small>
      </div>
    {% endif %}

    <div id="prediccion-alert" class="alert d-none" role="alert"></div>

    <div class="table-responsive">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Email</th>
            <th class="text-end">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes %}
            <tr>
              <td>{{ c.nombre }} {{ c.apellido }}</td>
              <td>{{ c.email }}</td>
              <td class="text-end">
                <button
                  type="button"
                  class="btn btn-sm btn-primary btn-predecir"
                  data-url="{% url 'predicciones:calcular_riesgo' c.id %}">
                  Predecir
                </button>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="text-center text-muted py-4">No hay clientes para predecir</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const alertEl = document.getElementById('prediccion-alert');
    const buttons = document.querySelectorAll('.btn-predecir');
    const trainBtn = document.getElementById('btnEntrenarModelo');

    function showAlert(kind, text) {
      alertEl.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
      alertEl.classList.add('alert-' + kind);
      alertEl.textContent = text;
    }

    buttons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url');
        if (!url) return;

        btn.disabled = true;
        try {
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await res.json();

          if (!res.ok) {
            showAlert('danger', data.error || 'No se pudo calcular el riesgo');
            return;
          }

          const cliente = data.cliente || 'Cliente';
          const prob = data.probabilidad_abandono;
          const nivel = data.nivel_riesgo;
          showAlert('success', `${cliente}: ${nivel} (${prob}% prob. abandono)`);
        } catch (e) {
          showAlert('danger', 'Error de red al calcular el riesgo');
        } finally {
          btn.disabled = false;
        }
      });
    });

    if (trainBtn) {
      trainBtn.addEventListener('click', async () => {
        const url = trainBtn.getAttribute('data-url');
        if (!url) return;

        trainBtn.disabled = true;
        try {
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const data = await res.json();

          if (!res.ok) {
            showAlert('danger', data.error || 'No se pudo entrenar el modelo');
            return;
          }

          const acc = (typeof data.accuracy === 'number') ? (data.accuracy * 100).toFixed(2) : 'N/A';
          const roc = (typeof data.roc_auc === 'number') ? data.roc_auc.toFixed(3) : 'N/A';
          showAlert('success', `Modelo entrenado. Accuracy: ${acc}% · ROC AUC: ${roc}`);
        } catch (e) {
          showAlert('danger', 'Error de red al entrenar el modelo');
        } finally {
          trainBtn.disabled = false;
        }
      });
    }
  })();
</script>
{% endblock %}
